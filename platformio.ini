; PlatformIO配置文件 - ESP32数据终端FreeRTOS版本
; 请将此文件放在项目根目录，命名为 platformio.ini

[env:esp32dev]
platform = espressif32
board = freenove_esp32_s3_wroom
framework = arduino

; 串口配置
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    time
    colorize

; 编译标志
build_flags = 
    ; 核心配置
    -DCORE_DEBUG_LEVEL=3                    ; 调试级别(0-5)
    -DARDUINO_RUNNING_CORE=1                ; Arduino运行在Core 1
    -DARDUINO_EVENT_RUNNING_CORE=0          ; 事件处理在Core 0
    
    ; FreeRTOS配置
    -DCONFIG_FREERTOS_HZ=1000               ; Tick频率1000Hz(精确1ms)
    -DCONFIG_FREERTOS_CHECK_STACKOVERFLOW=2  ; 堆栈溢出检测
    -DCONFIG_FREERTOS_THREAD_LOCAL_STORAGE_POINTERS=2
    
    ; 优化选项
    -O2                                     ; 优化级别
    -DBOARD_HAS_PSRAM                       ; 如果有PSRAM
    
    ; 自定义调试宏
    -DDEBUG_IMU_FREQUENCY=1                 ; 打印IMU频率
    -DDEBUG_TASK_STATUS=1                   ; 打印任务状态

; 库依赖
lib_deps = 
    ; 如果需要额外的库，在这里添加
    ; example: adafruit/Adafruit Sensor @ ^1.1.4

; 上传配置
upload_speed = 921600
; upload_port = COM3  ; Windows: COM3, Linux: /dev/ttyUSB0, Mac: /dev/cu.usbserial-*

; 开发板特定配置
board_build.partitions = default.csv
board_build.flash_mode = qio
board_build.f_cpu = 240000000L  ; CPU频率240MHz
board_build.f_flash = 80000000L  ; Flash频率80MHz

; ====================================================================
; 以下是不同应用场景的配置示例
; 取消注释相应部分即可使用
; ====================================================================

; ; -------------------- 调试模式 --------------------
; ; 用于开发和调试，包含更多调试信息
; [env:debug]
; extends = env:esp32dev
; build_type = debug
; build_flags = 
;     ${env:esp32dev.build_flags}
;     -DCORE_DEBUG_LEVEL=5                    ; 最详细的调试输出
;     -DDEBUG_STACK_USAGE=1                   ; 打印堆栈使用情况
;     -DDEBUG_MEMORY_USAGE=1                  ; 打印内存使用
;     -ggdb                                   ; GDB调试信息
;     -Og                                     ; 优化调试体验

; ; -------------------- 发布模式 --------------------
; ; 用于生产，优化性能和内存
; [env:release]
; extends = env:esp32dev
; build_flags = 
;     ${env:esp32dev.build_flags}
;     -DCORE_DEBUG_LEVEL=1                    ; 最小调试输出
;     -Os                                     ; 优化代码大小
;     -DNDEBUG                                ; 禁用断言
; build_unflags = -DDEBUG_IMU_FREQUENCY -DDEBUG_TASK_STATUS

; ; -------------------- 性能测试模式 --------------------
; ; 用于性能测试和基准测试
; [env:benchmark]
; extends = env:esp32dev
; build_flags = 
;     ${env:esp32dev.build_flags}
;     -DBENCHMARK_MODE=1                      ; 启用性能测试
;     -DLOG_TIMING=1                          ; 记录时序信息
;     -O3                                     ; 最高优化级别

; ; -------------------- 低功耗模式 --------------------
; ; 用于电池供电应用
; [env:lowpower]
; extends = env:esp32dev
; board_build.f_cpu = 160000000L              ; 降低CPU频率到160MHz
; build_flags = 
;     ${env:esp32dev.build_flags}
;     -DCONFIG_FREERTOS_HZ=100                ; 降低Tick频率
;     -DLOW_POWER_MODE=1                      ; 启用低功耗模式

; ====================================================================
; 高级配置选项
; ====================================================================

; -------------------- 自定义分区表 --------------------
; 如果需要更大的程序空间或更多OTA分区
; [env:custom_partition]
; extends = env:esp32dev
; board_build.partitions = custom_partitions.csv

; -------------------- 使用PSRAM --------------------
; 如果ESP32模块有PSRAM，可以启用
; [env:with_psram]
; extends = env:esp32dev
; build_flags = 
;     ${env:esp32dev.build_flags}
;     -DBOARD_HAS_PSRAM
;     -mfix-esp32-psram-cache-issue
; board_build.arduino.memory_type = qio_qspi

; -------------------- OTA更新支持 --------------------
; [env:ota]
; extends = env:esp32dev
; upload_protocol = espota
; upload_port = 192.168.1.100  ; ESP32的IP地址
; upload_flags = 
;     --auth=yourpassword

; ====================================================================
; 说明文档
; ====================================================================

; 如何使用：
;
; 1. 基本编译：
;    pio run
;
; 2. 上传程序：
;    pio run -t upload
;
; 3. 串口监视：
;    pio device monitor
;
; 4. 编译并上传并监视：
;    pio run -t upload && pio device monitor
;
; 5. 使用特定环境：
;    pio run -e debug
;    pio run -e release
;
; 6. 清理构建：
;    pio run -t clean
;
; 7. 完整重新构建：
;    pio run -t clean && pio run

; 常见问题：
;
; Q: 编译时提示内存不足？
; A: 1. 减少堆栈大小定义
;    2. 使用 -Os 优化代码大小
;    3. 启用PSRAM (如果有)
;
; Q: 上传失败？
; A: 1. 检查USB线连接
;    2. 确认COM口号正确
;    3. 尝试按住BOOT按钮再上传
;    4. 降低upload_speed
;
; Q: 运行时崩溃？
; A: 1. 启用堆栈溢出检测
;    2. 增加任务堆栈大小
;    3. 使用debug模式查看详细输出
;
; Q: FreeRTOS任务不运行？
; A: 1. 检查优先级设置
;    2. 确认任务创建成功
;    3. 查看vTaskDelay()时间是否合理
